<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CertifyEsam</title>
    <link rel="icon" href="/interfaz-de-usuario.png" type="image/png" />
    <style>
      /* --- Importación de Fuentes y Iconos --- */
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap");
      @import url("https://cdn-uicons.flaticon.com/2.4.2/uicons-regular-rounded/css/uicons-regular-rounded.css");
      @import url("https://cdn-uicons.flaticon.com/2.4.2/uicons-solid-rounded/css/uicons-solid-rounded.css");

      /* --- NUEVA Paleta de Colores Vibrante --- */
      :root {
        --primary-color: #011f50;  /* Azul Fuerte */
        --secondary-color: #035077; /* Azul Cielo */
        --accent-color: #FFD200;   /* Amarillo Vibrante */
        --success-color: #05C148;
        --success-colors: #0061ff;  /* Verde Fuerte */
        --error-color: #dc3545;
        --orange-accent: #F7971E;  /* Naranja Fuerte */

        --background-color: #FFFFFF; /* Fondo Blanco Puro */
        --surface-color: #FFFFFF;
        --text-primary-color: #1A202C;
        --text-secondary-color: #5A6474;
        --border-color: #E2E8F0;
        --shadow-color: rgba(0, 82, 212, 0.15); /* Sombra basada en el azul */
      }

      /* --- Estilos Generales y Reset --- */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Poppins", sans-serif;
        background-color: var(--background-color);
        color: var(--text-primary-color);
        transition: background-color 0.5s ease;
        overflow-x: hidden;
      }

      /* --- Contenedores Principales de Vistas --- */
      .view {
        min-height: 100vh;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 40px 20px;
        box-sizing: border-box;
      }

      #search-view {
        justify-content: center;
      }

      #results-view {
        display: none;
        justify-content: flex-start;
        position: relative;
      }

      /* --- NUEVAS Animaciones de Entrada --- */
      @keyframes slideInFromLeft {
        from { opacity: 0; transform: translateX(-30px); }
        to { opacity: 1; transform: translateX(0); }
      }
      @keyframes slideInFromRight {
        from { opacity: 0; transform: translateX(30px); }
        to { opacity: 1; transform: translateX(0); }
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
      }


      /* --- NUEVO Diseño de la Vista de Búsqueda --- */
      .search-container {
        width: 100%;
        max-width: 500px; /* Reducido un poco */
        text-align: center;
        border-top: 4px solid; /* Borde más delgado */
        border-image-slice: 1;
        border-image-source: linear-gradient(to left, var(--accent-color), var(--success-colors), var(--success-color));
        padding-top: 30px; /* Espacio reducido */
      }

      .logo-container {
        margin-bottom: 20px; /* Reducido */
        animation: slideInFromLeft 0.6s ease-out backwards;
      }
      /* --- Estilo para el LOGO --- */
      .logo-container img {
          max-width: 150px; /* Ajusta el tamaño máximo de tu logo */
          height: auto;
      }

      .search-container h1 {
        font-size: 2.2rem; /* Reducido */
        font-weight: 700;
        margin-bottom: 8px; /* Reducido */
        color: var(--text-primary-color);
        animation: slideInFromRight 0.7s ease-out backwards;
        animation-delay: 0.1s;
      }

      .search-container p {
        color: var(--text-secondary-color);
        margin-bottom: 30px; /* Reducido */
        font-size: 1rem; /* Reducido */
        max-width: 400px; /* Reducido */
        margin-left: auto;
        margin-right: auto;
        line-height: 1.6;
        animation: slideInFromLeft 0.7s ease-out backwards;
        animation-delay: 0.2s;
      }

      #search-form {
        display: flex;
        flex-direction: column;
        gap: 18px; /* Reducido */
        animation: slideInFromRight 0.7s ease-out backwards;
        animation-delay: 0.3s;
      }

      .input-wrapper {
        position: relative;
      }

      .input-wrapper .fi {
        position: absolute;
        top: 50%;
        left: 18px; /* Ajustado */
        transform: translateY(-50%);
        color: #B0BCCF;
        font-size: 18px; /* Reducido */
        transition: color 0.3s ease;
      }

      #search-input {
        width: 80%;
        padding: 14px 14px 14px 50px; /* Reducido */
        border: 2px solid var(--border-color);
        border-radius: 70px;
        font-size: 1rem;
        font-family: "Poppins", sans-serif;
        background: var(--background-color);
        color: var(--text-primary-color);
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
      }

      #search-input:focus {
        outline: none;
        border-radius: 30px 35px;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--shadow-color); /* Sombra más pequeña */
      }
      #search-input:focus ~ .fi {
        color: var(--primary-color);
      }

      .submit-button {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px; /* Reducido */
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 8px; /* Ligeramente más alto para mejor click */
        border-radius: 30px; /* Coincide con el input */
        cursor: pointer;
        font-size:9px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 3px 10px var(--shadow-color); /* Más sutil */
        width: 33%; /* Botón de ancho completo */
      }

      .submit-button:hover {
        transform: translateY(-2px); /* Movimiento reducido */
        background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
        box-shadow: 0 4px 15px var(--shadow-color); /* Más sutil */
      }

      .submit-button:active {
        transform: translateY(0px);
      }

      .submit-button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: translateY(0);
      }

      .submit-button .fi {
        font-size: 1.2rem;
      }


      /* Loader (Mantiene el diseño) */
      .loader { display: flex; justify-content: center; margin: 20px 0 0; }
      .loader-dots { width: 60px; display: flex; justify-content: space-around; }
      .loader-dots div { width: 10px; height: 10px; background-color: var(--primary-color); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
      .loader-dots .dot1 { animation-delay: -0.32s; }
      .loader-dots .dot2 { animation-delay: -0.16s; }
      @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

      /* Contenedor de errores (Mantiene el diseño) */
      #error-container { margin-top: 20px; } /* Reducido */
      .error-message { color: var(--error-color); border: 1px solid var(--error-color); background-color: #f8d7da; padding: 12px 18px; border-radius: 10px; text-align: center; animation: shake-horizontal 0.5s ease; box-shadow: 0 4px 15px rgba(220, 53, 69, 0.2); }
      @keyframes shake-horizontal { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70% { transform: translateX(-8px); } 20%, 40%, 60% { transform: translateX(8px); } 80% { transform: translateX(6px); } 90% { transform: translateX(-6px); } }
      .contact-support { margin-top: 12px; padding-top: 12px; border-top: 1px solid #f5c6cb; display: flex; justify-content: center; gap: 20px; align-items: center; }
      .contact-support img { transition: transform 0.2s; width: 25px; } /* Imagen reducida */
      .contact-support a:hover img { transform: scale(1.15); }


      /* --- Estilos de la Vista de Resultados (Diseño Renovado) --- */
      .results-header {
        width: 100%;
        max-width: 1200px;
        margin-bottom: 30px; /* Reducido */
        padding: 25px; /* Reducido */
        border-radius: 16px; /* Reducido */
        animation: slideInFromLeft 0.8s ease backwards; /* ANIMACIÓN AÑADIDA */
      }
      .results-header h2 {
        font-size: 1.8rem; /* Reducido */
        font-weight: 600;
        margin-bottom: 5px;
      }
      .results-header h2 .fi {
        color: var(--primary-color);
        margin-right: 10px;
        vertical-align: middle;
      }
      .results-header p {
        color: var(--text-secondary-color);
        font-size: 1rem; /* Reducido */
      }
      .new-search-button {
          margin-top: 15px; /* Reducido */
          background: transparent;
          border: 2px solid var(--primary-color);
          color: var(--primary-color);
          padding: 8px 18px; /* Reducido */
          border-radius: 8px; /* Reducido */
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s ease;
          font-size: 0.9rem; /* Reducido */
      }
      .new-search-button:hover {
          background-color: var(--primary-color);
          color: white;
      }

      /* --- BOTÓN DE FILTRO FLOTANTE y MENÚ (Tamaño reducido) --- */
      #filter-fab {
          position: fixed;
          bottom: 25px; /* Ajustado */
          right: 25px; /* Ajustado */
          width: 50px; /* Reducido */
          height: 50px; /* Reducido */
          background: var(--primary-color);
          border-radius: 50%;
          border: none;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2); /* Sombra reducida */
          cursor: pointer;
          z-index: 1001;
          transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
          animation: slideInFromRight 0.8s 0.5s ease backwards; /* ANIMACIÓN AÑADIDA */
      }
      #filter-fab:hover {
          transform: scale(1.1) translateY(-4px);
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
      }
      #filter-fab i {
          font-size: 1.5rem; /* Reducido */
          color: white;
          transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      }
      .filters-container {
        position: fixed;
        bottom: 85px; /* Ajustado */
        right: 25px; /* Ajustado */
        width: 260px; /* Reducido */
        background-color: var(--surface-color);
        padding: 18px; /* Reducido */
        border-radius: 16px; /* Reducido */
        /* box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); Sombra reducida */
        display: flex;
        flex-direction: column;
        gap: 15px; /* Reducido */
        z-index: 1000;
        visibility: hidden;
        opacity: 0;
        transform: translateY(20px) scale(0.95);
        transform-origin: bottom right;
        transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
      }
      .filters-container.visible {
          visibility: visible;
          opacity: 1;
          transform: translateY(0) scale(1);
      }
      .filters-container.visible + #filter-fab {
          background-color: var(--orange-accent);
      }
      .filters-container.visible + #filter-fab i {
          transform: rotate(135deg);
      }
      .filter-group label {
        font-size: 0.85rem; /* Reducido */
        font-weight: 500;
        margin-bottom: 6px; /* Reducido */
        color: var(--text-secondary-color);
      }
      .filter-select {
        width: 100%;
        padding: 10px 15px; /* Reducido */
        border: 1px solid var(--border-color);
        border-radius: 28px; /* Reducido */
        background-color: var(--background-color);
        font-family: "Poppins", sans-serif;
        font-size: 0.9rem; /* Reducido */
        cursor: pointer;
        -webkit-appearance: none;
        appearance: none;
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%230052D4%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
        background-repeat: no-repeat;
        background-position: right 12px top 50%;
        background-size: 9px; /* Reducido */
        transition: all 0.2s ease;
      }
      .filter-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--shadow-color);
      }

      /* Contenedor de Certificados (Diseño de Tarjeta Renovado) */
      #certificates-list {
        width: 100%;
        max-width: 1200px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); /* Ancho mínimo reducido */
        gap: 25px; /* Reducido */
        padding-bottom: 100px; /* Reducido */
      }

      .certificate-card {
        background: var(--surface-color);
        border-radius: 14px; /* Reducido */
        transition: transform 0.3s, box-shadow 0.3s;
        display: flex;
        flex-direction: column;
        animation: card-appear 0.5s ease backwards;
        overflow: hidden;
        border-left: 5px solid; /* Borde reducido */
      }
      .certificate-card.estudiante { border-color: #011f50; }
      .certificate-card.docente { border-color: var(--orange-accent); }

      .certificate-card:hover {
        transform: translateY(-6px) scale(1.02); /* Movimiento reducido */
        box-shadow: 0 10px 35px var(--shadow-color); /* Sombra reducida */
      }
      @keyframes card-appear {
          from { opacity: 0; transform: scale(0.95) translateY(10px); }
          to { opacity: 1; transform: scale(1) translateY(0); }
      }

      /* Contenido de la tarjeta */
      .card-content {
        padding: 20px; /* Reducido */
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px; /* Reducido */
        padding-bottom: 12px; /* Reducido */
        border-bottom: 1px solid var(--border-color);
      }
      .card-header h3 {
        font-size: 0.9rem;                       /* Letras pequeñas */
        font-weight: 600;
        font-family: "Times New Roman", serif;   /* Estilo gótico */
        line-height: 1.3;
        padding-right: 8px;
        color: #222;
        cursor: pointer;

        display: -webkit-box;
        -webkit-line-clamp: 1;   /* Mostrar solo 1 línea */
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;

        max-height: 1.5em;       /* Altura inicial */
        transition: max-height 0.4s ease;
      }

      /* Cuando pasas el cursor, se despliega */
      .card-header h3:hover {
        -webkit-line-clamp: unset; /* Quita límite */
        max-height: 500px;         /* Altura grande para mostrar todo */
      }

      .certificate-badge {
        padding: 5px 12px; /* Reducido */
        border-radius: 20px;
        font-size: 0.75rem; /* Reducido */
        font-weight: 600;
        color: white;
        white-space: nowrap;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15); /* Sombra reducida */
      }
      .certificate-badge.estudiante { background: var(--success-color); }
      .certificate-badge.docente { background: var(--orange-accent); }

      .card-body p {
        color: var(--text-secondary-color);
        font-size: 0.9rem; /* Reducido */
        margin-bottom: 8px; /* Reducido */
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .card-body p strong {
        color: var(--text-primary-color);
        font-weight: 600;
      }
      .badge-sede {
        padding: 4px 10px; /* Reducido */
        border-radius: 20px;
        font-size: 0.8rem; /* Reducido */
        font-weight: 600;
        color: var(--text-primary-color);
        background-color: var(--accent-color);
      }

      .card-footer {
        margin-top: auto;
        padding-top: 15px; /* Reducido */
      }
      .download-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        padding: 10px 14px;
        border-radius: 38px; /* Reducido */
        font-weight: 600;
        color: white;
        background-color: var(--primary-color);
        transition: all 0.2s ease;
        justify-content: center;
        font-size: 0.9rem;
      }
      .download-link .fi { font-size: 1.1rem; } /* Reducido */
      .download-link:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px var(--shadow-color); /* Sombra reducida */
      }

      #no-results-message {
          display: none;
          width: 100%;
          text-align: center;
          padding: 40px; /* Reducido */
          background-color: #f8f9fa;
          border-radius: 16px; /* Reducido */
          color: var(--text-secondary-color);
          font-size: 1rem; /* Reducido */
          box-shadow: 0 8px 30px var(--shadow-color);
          animation: fadeIn 1s ease; /* ANIMACIÓN AÑADIDA */
      }

      /* --- Responsividad --- */
      @media (max-width: 768px) {
        .search-container { padding: 30px 20px 0 20px; border-width: 3px; }
        .search-container h1 { font-size: 1.8rem; }
        .view { padding: 25px 15px; }
        #certificates-list { grid-template-columns: 1fr; }
        #filter-fab { width: 50px; height: 50px; right: 15px; bottom: 15px; }
        .filters-container { right: 15px; bottom: 75px; }
      }
      @media (max-width: 480px) {
         .search-container { padding: 25px 15px 0 15px; }
         .filters-container { width: calc(100vw - 30px); right: 15px; }
      }
    </style>
</head>
<body>
    <!-- Vista Inicial de Búsqueda -->
    <main id="search-view" class="view">
      <div class="search-container">
        <div class="logo-container">
            <!-- Pega aquí la URL de tu logo -->
            <img src="/logo esam.png" alt="Logo de la Institución">
        </div>
        <h1></h1>
        <p>Ingresa tu número de Carnet de Identidad (CI) para consultar y verificar tus certificados emitidos.</p>
        <form id="search-form">
          <div class="input-wrapper">
            <input type="text" id="search-input" placeholder="Ej: 12345678" required />
            <i class="fi fi-rr-id-badge"></i>
          </div>
          <button type="submit" class="submit-button">
            <i class="fi fi-rr-search-alt"></i>
            <span>Buscar</span>
          </button>
        </form>
        <div id="loader" style="display: none">
            <div class="loader-dots">
              <div class="dot1"></div><div class="dot2"></div><div class="dot3"></div>
            </div>
        </div>
        <div id="error-container"></div>
      </div>
    </main>

    <!-- Vista de Resultados (Oculta por defecto) -->
    <section id="results-view" class="view">
      <header class="results-header">
        <h2 id="results-title"></h2>
        <p id="results-count"></p>
        <button id="new-search" class="new-search-button">
            <i class="fi fi-rr-search"></i>Otra Búsqueda
        </button>
      </header>

      <div id="certificates-list"></div>
      <p id="no-results-message">No se encontraron certificados que coincidan con los filtros seleccionados.</p>

      <div id="filters-container" class="filters-container">
        <div class="filter-group">
          <label for="sede-filter">Filtros</label>
          <select id="sede-filter" class="filter-select">
            <option value="all">Todas las sedes</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="program-filter">Programas</label>
          <select id="program-filter" class="filter-select">
            <option value="all">Todos los programas</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="date-filter"> Fecha de Emisión</label>
          <select id="date-filter" class="filter-select">
            <option value="all">Todas las fechas</option>
          </select>
        </div>
      </div>

      <button id="filter-fab" title="Mostrar/Ocultar Filtros">
          <i class="fi fi-sr-filter"></i>
      </button>

    </section>

    <script>
      // --- Variables Globales y Constantes ---
      const SCRIPT_URL_MONTEAGUDO = "https://script.google.com/macros/s/AKfycbxCN3pDynC7iNORHckEunyzCZ1MGC7pTSMF5VAC0lTJoHZtSGWjByL2q88cuzkkEy3kVw/exec";
      const SCRIPT_URL_SUCRE = "https://script.google.com/a/macros/esam.edu.bo/s/AKfycbw1Asy91Pclqlvd7OyJJnt8_O0o8GG56vWFNHymkKhK2zH67e3vl-BrNptFkAyq0Zei/exec";
      let allCertificates = [];

      // --- Selectores del DOM ---
      const searchView = document.getElementById("search-view");
      const resultsView = document.getElementById("results-view");
      const form = document.getElementById("search-form");
      const searchInput = document.getElementById("search-input");
      const submitButton = form.querySelector('button[type="submit"]');
      const loader = document.getElementById("loader");
      const errorContainer = document.getElementById("error-container");
      const certificatesListContainer = document.getElementById("certificates-list");
      const resultsTitle = document.getElementById("results-title");
      const resultsCount = document.getElementById("results-count");
      const filtersContainer = document.getElementById("filters-container");
      const sedeFilter = document.getElementById("sede-filter");
      const programFilter = document.getElementById("program-filter");
      const dateFilter = document.getElementById("date-filter");
      const newSearchButton = document.getElementById("new-search");
      const noResultsMessage = document.getElementById("no-results-message");
      const filterFab = document.getElementById("filter-fab");

      // --- Manejadores de Eventos ---
      form.addEventListener("submit", handleSearchSubmit);
      sedeFilter.addEventListener("change", applyFiltersAndRender);
      programFilter.addEventListener("change", applyFiltersAndRender);
      dateFilter.addEventListener("change", applyFiltersAndRender);
      newSearchButton.addEventListener("click", resetToSearchView);
      filterFab.addEventListener("click", toggleFiltersVisibility);

      // --- Lógica Principal de Búsqueda ---
      async function handleSearchSubmit(e) {
        e.preventDefault();
        const searchId = searchInput.value.trim().replace(/\s/g, "");
        if (!/^\d{7,}$/.test(searchId)) {
          displayError("Ups. :(  Carnet no válido", "Por favor, ingrese un número de carnet válido (al menos 7 dígitos, sin letras ni guiones).");
          return;
        }
        setLoadingState(true);
        try {
          const fetchMonteagudo = fetch(`${SCRIPT_URL_MONTEAGUDO}?searchId=${encodeURIComponent(searchId)}`).then(res => res.json());
          const fetchSucre = fetch(`${SCRIPT_URL_SUCRE}?searchId=${encodeURIComponent(searchId)}`).then(res => res.json());
          const responses = await Promise.allSettled([fetchMonteagudo, fetchSucre]);
          let combinedCertificates = [];
          if (responses[0].status === 'fulfilled' && responses[0].value.success) {
            const monteagudoCerts = responses[0].value.data.map(cert => ({ ...cert, sede: 'Monteagudo' }));
            combinedCertificates.push(...monteagudoCerts);
          }
          if (responses[1].status === 'fulfilled' && responses[1].value.success) {
            const sucreCerts = responses[1].value.data.map(cert => ({ ...cert, sede: 'Sucre' }));
            combinedCertificates.push(...sucreCerts);
          }
          if (combinedCertificates.length > 0) {
            allCertificates = combinedCertificates;
            switchToResultsView();
            populateFilters();
            applyFiltersAndRender();
          } else {
            displayError("Ups Certificado no encontrado", "Verifique que el número sea correcto. Si el problema persiste, por favor contacte al soporte.");
          }
        } catch (error) {
          console.error("Fetch error:", error);
          displayError("Error de Conexión", "No se pudo conectar con el servidor. Por favor, verifique su conexión a internet e inténtelo de nuevo.");
        } finally {
          setLoadingState(false);
        }
      }

      // --- Manipulación de Vistas y Estados ---
      function setLoadingState(isLoading) {
        if (isLoading) {
            submitButton.disabled = true;
            submitButton.querySelector('span').textContent = 'Buscando...';
            loader.style.display = "flex";
            errorContainer.innerHTML = "";
        } else {
            submitButton.disabled = false;
            submitButton.querySelector('span').textContent = 'Verificar';
            loader.style.display = "none";
        }
      }

      function switchToResultsView() {
          searchView.style.display = "none";
          resultsView.style.display = "flex";
      }

      function resetToSearchView() {
          resultsView.style.display = "none";
          searchView.style.display = "flex";
          searchInput.value = "";
          errorContainer.innerHTML = "";
          allCertificates = [];
          certificatesListContainer.innerHTML = "";
          filtersContainer.classList.remove('visible');
      }

      // --- Lógica de Filtros y Renderizado ---
      function toggleFiltersVisibility() {
          filtersContainer.classList.toggle('visible');
      }

      function populateFilters() {
        const uniqueSedes = [...new Set(allCertificates.map(cert => cert.sede))];
        const uniquePrograms = [...new Set(allCertificates.map(cert => cert.descripcion))];
        const uniqueDates = [...new Set(allCertificates.map(cert => cert.fecha))];
        sedeFilter.innerHTML = '<option value="all">Todas las sedes</option>';
        programFilter.innerHTML = '<option value="all">Todos los programas</option>';
        dateFilter.innerHTML = '<option value="all">Todas las fechas</option>';
        uniqueSedes.forEach(sede => {
            const option = document.createElement('option');
            option.value = sede; option.textContent = sede;
            sedeFilter.appendChild(option);
        });
        uniquePrograms.forEach(program => {
            const option = document.createElement('option');
            option.value = program; option.textContent = program;
            programFilter.appendChild(option);
        });
        uniqueDates.sort().forEach(date => {
            const option = document.createElement('option');
            option.value = date; option.textContent = date;
            dateFilter.appendChild(option);
        });
      }

      function applyFiltersAndRender() {
        const selectedSede = sedeFilter.value;
        const selectedProgram = programFilter.value;
        const selectedDate = dateFilter.value;
        const filteredCertificates = allCertificates.filter(cert => {
            const sedeMatch = selectedSede === 'all' || cert.sede === selectedSede;
            const programMatch = selectedProgram === 'all' || cert.descripcion === selectedProgram;
            const dateMatch = selectedDate === 'all' || cert.fecha === selectedDate;
            return sedeMatch && programMatch && dateMatch;
        });
        renderCertificates(filteredCertificates);
      }

      // --- NUEVA FUNCIÓN ---
      // Convierte una URL de Google Drive a un enlace de descarga directa.
      function createGoogleDriveDownloadUrl(originalUrl) {
          if (!originalUrl || !originalUrl.includes('drive.google.com')) {
              return originalUrl; // Devuelve la original si no es de Google Drive
          }
          // Extrae el ID del archivo de la URL
          const regex = /\/d\/([a-zA-Z0-9_-]+)/;
          const match = originalUrl.match(regex);
          if (match && match[1]) {
              const fileId = match[1];
             
              return `https://drive.google.com/uc?export=download&id=${fileId}`;
          }
          return originalUrl; // Devuelve la original como fallback si no encuentra el ID
      }


      function renderCertificates(certificatesToRender) {
        const holderName = allCertificates[0]?.nombre || 'Usuario';
        resultsTitle.innerHTML = `<i class="fi fi-rr-file-certificate"></i> Econtramos como: ${holderName}`;
        resultsCount.textContent = `Se encontraron ${certificatesToRender.length} de ${allCertificates.length} certificados.`;
        certificatesListContainer.innerHTML = "";
        if (certificatesToRender.length === 0) {
            noResultsMessage.style.display = "block";
            certificatesListContainer.style.display = "none";
        } else {
            noResultsMessage.style.display = "none";
            certificatesListContainer.style.display = "grid";
        }
        certificatesToRender.forEach((cert, index) => {
          const typeClass = cert.type.toLowerCase();
          const card = document.createElement('div');
          // --- MODIFICACIÓN ---
          // Se llama a la nueva función para obtener la URL de descarga directa
          const downloadUrl = createGoogleDriveDownloadUrl(cert.urlPdf);

          card.className = `certificate-card ${typeClass}`;
          card.style.animationDelay = `${index * 100}ms`;
          card.innerHTML = `
            <div class="card-content" style="border:1px solid #ddd; border-radius:10px; padding:15px; max-width:350px; background:#f9f9f9; box-shadow:0 4px 8px rgba(0,0,0,0.1); font-family:Arial,sans-serif;">
            <div class="card-content">
              <div class="card-header">
                <h3><i class="fi fi-rr-certificate"></i> ${cert.descripcion}</h3>
                <span class="certificate-badge ${typeClass}">
                  <i class="fi fi-rr-badge"></i> ${cert.type}
                </span>
              </div>
              <div class="card-body">
                <p><i class="fi fi-rr-building"></i> <strong>Sede:</strong> <span class="badge-sede">${cert.sede}</span></p>
                <p><i class="fi fi-rr-calendar"></i> <strong>Emitido el:</strong> ${cert.fecha}</p>
              </div>
              <div class="card-footer">
                <!-- --- MODIFICACIÓN --- -->
                <!-- Se usa la nueva URL, se añade 'download' y se cambia el texto/icono -->
                <a href="${downloadUrl}" download class="download-link">
                  <i class="fi fi-rr-download"></i> Descargar
                </a>
              </div>
            </div>
            `;
          certificatesListContainer.appendChild(card);
        });
      }

      // --- Manejo de Errores ---
      function displayError(title, message) {
        let contactInfo = "";
        if (title === "Ups Certificado no encontrado") {
            const WHATSAPP_NUMBER = "59174681419";
            const PREWRITTEN_MESSAGE = "*Hola ing, tengo un error sobre mi certificado de:*.";
            const WHATSAPP_URL = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(PREWRITTEN_MESSAGE)}`;
            contactInfo = `
                <div class="contact-support">
                    <a href="mailto:efrain.chiri@esam.edu.bo" title="Enviar correo">
                        <img src="https://cdn.icon-icons.com/icons2/2631/PNG/512/gmail_new_logo_icon_159149.png" alt="Email" width="30">
                    </a>
                    <a href="${WHATSAPP_URL}" target="_blank" title="Contactar por WhatsApp">
                        <img src="https://cdn.icon-icons.com/icons2/729/PNG/512/whatsapp_icon-icons.com_62756.png" alt="WhatsApp" width="30">
                    </a>
                </div>`;
        }

        errorContainer.innerHTML = `
          <div class="error-message">
            <strong>${title}:</strong> ${message}
            ${contactInfo}
          </div>`;
      }
    </script>
</body>
</html>