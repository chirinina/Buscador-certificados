<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Esam.edu.bo</title>
    <link rel="icon" href="/interfaz-de-usuario.png" type="image/png" />
    <style>
      /* --- Importación de Fuentes y Iconos --- */
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap");
      @import url("https://cdn-uicons.flaticon.com/2.4.2/uicons-regular-rounded/css/uicons-regular-rounded.css");

      /* --- Variables de Diseño (Nueva Paleta Sofisticada) --- */
      :root {
        --primary-color: #007BFF; /* Un azul más vibrante y moderno */
        --secondary-color: #00B4DB; /* Un cian para gradientes */
        --accent-color: #FFC107; /* Un toque de amarillo para acentos */
        --background-start-color: #E0E5EC; /* Un fondo claro y suave tipo Neumorphism */
        --background-end-color: #FAFBFF;
        --surface-color: #F0F2F5; /* Superficie de las tarjetas y contenedores */
        --text-primary-color: #1A202C;
        --text-secondary-color: #5A6474;
        --border-color: #DDE2E8;
        --success-color: #28a745;
        --info-color: #17a2b8;
        --error-color: #dc3545;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --highlight-shadow-light: rgba(255, 255, 255, 0.8);
        --highlight-shadow-dark: rgba(163, 177, 198, 0.6);
      }

      /* --- Estilos Generales y Reset --- */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Poppins", sans-serif;
        background: linear-gradient(135deg, var(--background-start-color) 0%, var(--background-end-color) 100%);
        color: var(--text-primary-color);
        transition: background-color 0.5s ease;
        overflow-x: hidden;
      }
      
      /* --- Contenedor de cambio de idioma --- */
      .language-switcher {
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 1000;
          background: var(--surface-color);
          border-radius: 12px;
          box-shadow: 5px 5px 15px var(--highlight-shadow-dark), -5px -5px 15px var(--highlight-shadow-light);
          display: flex;
          padding: 5px;
      }
      .lang-btn {
          background: transparent;
          border: none;
          cursor: pointer;
          padding: 8px 12px;
          border-radius: 8px;
          transition: background-color 0.3s, color 0.3s;
      }
      .lang-btn img {
          width: 24px;
          height: 24px;
          vertical-align: middle;
      }
      .lang-btn.active {
          background-color: var(--primary-color);
          box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2);
      }
      .lang-btn:not(.active):hover {
          background-color: var(--background-start-color);
      }


      /* --- Contenedores Principales de Vistas --- */
      .view {
        min-height: 100vh;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 40px 20px;
        box-sizing: border-box;
        animation: fadeIn 0.8s ease-in-out;
      }

      #search-view {
        justify-content: center;
      }

      #results-view {
        display: none; /* Oculto por defecto */
        justify-content: flex-start;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
      }

      /* --- Estilos de la Vista de Búsqueda (Diseño Renovado) --- */
      .search-container {
        width: 100%;
        max-width: 550px;
        padding: 50px 45px;
        border-radius: 25px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.5);
      }
      
      .logo-container {
          margin-bottom: 25px;
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 20px;
      }
      .logo-container .fi {
          font-size: 3rem;
          color: var(--primary-color);
          padding: 15px;
          border-radius: 50%;
          background: var(--surface-color);
          box-shadow: 
            inset -5px -5px 10px var(--highlight-shadow-light),
            inset 5px 5px 10px var(--highlight-shadow-dark);
      }
      .logo-container .esam-logo {
          height: 60px; /* Ajusta la altura según sea necesario */
      }


      .search-container h1 {
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 10px;
        color: var(--text-primary-color);
      }

      .search-container p {
        color: var(--text-secondary-color);
        margin-bottom: 35px;
        font-size: 1rem;
        max-width: 380px;
        margin-left: auto;
        margin-right: auto;
      }

      #search-form {
        display: flex;
        flex-direction: column;
        gap: 25px;
      }

      .input-wrapper {
        position: relative;
      }

      .input-wrapper .fi {
        position: absolute;
        top: 50%;
        left: 20px;
        transform: translateY(-50%);
        color: #B0BCCF;
        font-size: 20px;
        transition: color 0.3s ease;
      }

      #search-input {
        width: 100%;
        padding: 18px 20px 18px 55px;
        border: none;
        border-radius: 15px;
        font-size: 1rem;
        font-family: "Poppins", sans-serif;
        background: var(--surface-color);
        color: var(--text-primary-color);
        box-shadow: 
            inset -5px -5px 10px var(--highlight-shadow-light),
            inset 5px 5px 10px var(--highlight-shadow-dark);
        transition: box-shadow 0.3s ease;
      }

      #search-input:focus {
        outline: none;
        box-shadow: 
            inset -3px -3px 7px var(--highlight-shadow-light),
            inset 3px 3px 7px var(--highlight-shadow-dark),
            0 0 0 4px rgba(0, 123, 255, 0.15);
      }
      #search-input:focus ~ .fi {
        color: var(--primary-color);
      }

      .submit-button {
        display: flex;
        align-items: center;
        justify-content: center;
        /* gap: 12px; MODIFICADO */
        background: linear-gradient(145deg, var(--secondary-color), var(--primary-color));
        color: white;
        border: none;
        padding: 18px;
        border-radius: 18px; /* MODIFICADO */
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 5px 5px 15px var(--highlight-shadow-dark), -5px -5px 15px var(--highlight-shadow-light);
        width: 68px; /* AÑADIDO */
        height: 68px; /* AÑADIDO */
        align-self: center; /* AÑADIDO */
      }
      .submit-button:hover {
        transform: translateY(-3px);
        box-shadow: 7px 7px 20px var(--highlight-shadow-dark), -7px -7px 20px var(--highlight-shadow-light);
      }
      .submit-button:active {
        transform: translateY(1px);
        box-shadow: 3px 3px 10px var(--highlight-shadow-dark), -3px -3px 10px var(--highlight-shadow-light);
      }
      .submit-button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: translateY(0);
      }
      .submit-button .fi {
        font-size: 1.6rem; /* MODIFICADO */
      }

      /* Loader */
      .loader {
        display: flex;
        justify-content: center;
        margin: 20px 0 0;
      }
      .loader-dots {
        width: 60px;
        display: flex;
        justify-content: space-around;
      }
      .loader-dots div {
        width: 10px; height: 10px;
        background-color: var(--primary-color);
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
      }
      .loader-dots .dot1 { animation-delay: -0.32s; }
      .loader-dots .dot2 { animation-delay: -0.16s; }
      @keyframes bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
      }

      /* Contenedor de errores */
      #error-container {
        margin-top: 25px;
      }
      .error-message {
        color: var(--error-color);
        border: 1px solid var(--error-color);
        background-color: #f8d7da;
        padding: 15px 20px;
        border-radius: 12px;
        text-align: center;
        animation: shake-horizontal 0.5s ease;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.2);
      }
       @keyframes shake-horizontal {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70% { transform: translateX(-8px); }
        20%, 40%, 60% { transform: translateX(8px); }
        80% { transform: translateX(6px); }
        90% { translateX(-6px); }
      }
      .contact-support {
          margin-top: 15px;
          padding-top: 15px;
          border-top: 1px solid #f5c6cb;
          display: flex;
          justify-content: center;
          gap: 20px;
          align-items: center;
      }
      .contact-support img {
        transition: transform 0.2s;
      }
      .contact-support a:hover img {
        transform: scale(1.15);
      }

      /* --- Estilos de la Vista de Resultados --- */
      .results-header {
        width: 100%;
        max-width: 1200px;
        margin-bottom: 30px;
        padding: 25px;
        border-radius: 20px;
        display: flex; /* AÑADIDO */
        flex-wrap: wrap; /* AÑADIDO */
        justify-content: space-between; /* AÑADIDO */
        align-items: center; /* AÑADIDO */
        gap: 15px; /* AÑADIDO */
      }
      .results-header-info {
        flex-grow: 1; /* AÑADIDO */
        display: flex; /* AÑADIDO */
        align-items: center; /* AÑADIDO */
        gap: 15px; /* AÑADIDO */
      }
       .results-header-info .esam-logo-header {
          height: 50px; /* Ajusta el tamaño para el header */
          display: none; /* Oculto en móviles para más espacio */
      }
      .results-header-text {
          flex-grow: 1;
      }
      .results-header h2 {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 5px;
      }
      .results-header h2 .fi {
        color: var(--primary-color);
        margin-right: 10px;
        vertical-align: middle;
      }
      .results-header p {
        color: var(--text-secondary-color);
        font-size: 1.1rem;
      }
      .new-search-button {
          /* margin-top: 20px; ELIMINADO */
          background: transparent;
          border: 2px solid var(--primary-color);
          color: var(--primary-color);
          padding: 10px; /* MODIFICADO */
          border-radius: 12px; /* MODIFICADO */
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s ease;
          width: 46px; /* AÑADIDO */
          height: 46px; /* AÑADIDO */
          display: flex; /* AÑADIDO */
          align-items: center; /* AÑADIDO */
          justify-content: center; /* AÑADIDO */
          font-size: 1.2rem; /* AÑADIDO */
      }
      .new-search-button:hover {
          background-color: var(--primary-color);
          color: white;
          box-shadow: 0 5px 15px rgba(0, 123, 255, 0.2);
      }


      /* Filtros */
      .filters-container {
        width: 100%;
        max-width: 1200px;
        padding: 20px;
        border-radius: 20px;
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }
      .filter-group {
        flex: 1;
        min-width: 200px;
      }
      .filter-group label {
        display: block;
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 8px;
        color: var(--text-secondary-color);
      }
      .filter-select {
        width: 100%;
        padding: 12px 18px;
        border: none;
        border-radius: 10px;
        background: var(--background-start-color);
        box-shadow: inset 2px 2px 5px var(--highlight-shadow-dark), inset -2px -2px 5px var(--highlight-shadow-light);
        font-family: "Poppins", sans-serif;
        font-size: 1rem;
        cursor: pointer;
        -webkit-appearance: none;
        appearance: none;
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007BFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
        background-repeat: no-repeat;
        background-position: right 15px top 50%;
        background-size: 10px;
        transition: all 0.2s ease;
      }
      .filter-select:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
      }

      /* Contenedor de Certificados */
      #certificates-list {
        width: 100%;
        max-width: 1200px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 30px;
      }

      .certificate-card {
        background: var(--surface-color);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 7px 7px 20px var(--highlight-shadow-dark), -7px -7px 20px var(--highlight-shadow-light);
        border: 1px solid rgba(255, 255, 255, 0.6);
        transition: transform 0.3s, box-shadow 0.3s;
        display: flex;
        flex-direction: column;
        animation: card-appear 0.5s ease backwards;
      }
      .certificate-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 10px 10px 25px var(--highlight-shadow-dark), -10px -10px 25px var(--highlight-shadow-light);
      }
      @keyframes card-appear {
          from { opacity: 0; transform: scale(0.95) translateY(10px); }
          to { opacity: 1; transform: scale(1) translateY(0); }
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
      }
      .card-header h3 {
        font-size: 1.25rem;
        font-weight: 600;
        line-height: 1.4;
        padding-right: 15px;
      }

      .certificate-badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        color: white;
        white-space: nowrap;
        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        text-transform: capitalize;
      }
      .certificate-badge.estudiante { background: linear-gradient(145deg, #28a745, #218838); }
      .certificate-badge.docente { background: linear-gradient(145deg, #17a2b8, #138496); }
      .certificate-badge.student { background: linear-gradient(145deg, #28a745, #218838); }
      .certificate-badge.teacher { background: linear-gradient(145deg, #17a2b8, #138496); }


      .card-body p {
        color: var(--text-secondary-color);
        font-size: 0.95rem;
        margin-bottom: 8px;
      }
      .card-body p strong {
        color: var(--text-primary-color);
        font-weight: 600;
      }

      .card-footer {
        margin-top: auto;
        padding-top: 20px;
      }
      .download-link {
        display: inline-flex;
        align-items: center;
        /* gap: 8px; MODIFICADO */
        text-decoration: none;
        padding: 12px 25px;
        border-radius: 10px;
        font-weight: 600;
        color: white;
        transition: all 0.2s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        width: 100%;
        justify-content: center;
      }
      .download-link .fi {
        font-size: 1.2rem;
      }
      .download-link.estudiante, .download-link.student { background: var(--success-color); }
      .download-link.docente, .download-link.teacher { background: var(--info-color); }

      .download-link:hover {
        transform: translateY(-2px);
        box-shadow: 0 7px 20px rgba(0,0,0,0.15);
      }
      
      #no-results-message {
          display: none;
          width: 100%;
          text-align: center;
          padding: 50px;
          background-color: var(--surface-color);
          border-radius: 20px;
          color: var(--text-secondary-color);
          font-size: 1.1rem;
          box-shadow: 5px 5px 15px var(--highlight-shadow-dark), -5px -5px 15px var(--highlight-shadow-light);
      }

      /* --- Responsividad --- */
      @media (max-width: 768px) {
        .search-container {
            padding: 40px 25px;
        }
        .search-container h1 { font-size: 2rem; }
        .view { padding: 30px 15px; }
        #certificates-list {
            grid-template-columns: 1fr;
        }
      }
      @media (max-width: 480px) {
        .filters-container {
            flex-direction: column;
        }
         .search-container {
            padding: 35px 20px;
        }
        .results-header {
            flex-direction: column;
            justify-content: center;
            text-align: center;
        }
        .results-header-info {
            justify-content: center;
        }
        .results-header-info .esam-logo-header {
            display: block; /* Mostrar el logo en el header en móviles */
        }
      }
    </style>
</head>
<body>
    <!-- Botones para cambiar idioma -->
    <div class="language-switcher">
        <button class="lang-btn active" id="lang-es" title="Español">
            <img src="https://em-content.zobj.net/source/twitter/376/flag-spain_1f1ea-1f1f8.png" alt="ES">
        </button>
        <button class="lang-btn" id="lang-en" title="English">
            <img src="https://em-content.zobj.net/source/twitter/376/flag-united-states_1f1fa-1f1f8.png" alt="EN">
        </button>
    </div>

    <!-- Vista Inicial de Búsqueda -->
    <main id="search-view" class="view">
      <div class="search-container">
        <div class="logo-container">
            <!-- Logos de ESAM -->
            <img src="logo esam.png" alt="Logo ESAM 1" class="esam-logo">
            <img src="UNSXX.png" alt="Logo ESAM 2" class="esam-logo">
        </div>
        <h1 data-key="validation_portal">Portal de Validación</h1>
        <p data-key="search_prompt">Ingresa tu número de Carnet de Identidad (CI) para consultar y verificar tus certificados emitidos.</p>
        <form id="search-form">
          <div class="input-wrapper">
            <input type="text" id="search-input" placeholder="Ej: 12345678" required />
            <i class="fi fi-rr-id-badge"></i>
          </div>
          <button type="submit" class="submit-button" title="Verificar" data-key-title="verify_button_title">
            <i class="fi fi-rr-search-alt"></i>
          </button>
        </form>
        <div id="loader" style="display: none">
            <div class="loader-dots">
              <div class="dot1"></div><div class="dot2"></div><div class="dot3"></div>
            </div>
        </div>
        <div id="error-container"></div>
      </div>
    </main>

    <!-- Vista de Resultados (Oculta por defecto) -->
    <section id="results-view" class="view">
      <header class="results-header">
        <div class="results-header-info">
            <!-- Logo de ESAM para el header -->
            <img src="https://www.esam.edu.bo/wp-content/uploads/2021/02/logo-esam-dark.png" alt="Logo ESAM" class="esam-logo-header">
            <div class="results-header-text">
                <h2 id="results-title"></h2>
                <p id="results-count"></p>
            </div>
        </div>
        <button id="new-search" class="new-search-button" title="Realizar Nueva Búsqueda" data-key-title="new_search_button_title">
            <i class="fi fi-rr-search"></i>
        </button>
      </header>
      
      <div id="filters-container" class="filters-container">
        <div class="filter-group">
          <label for="program-filter" data-key="filter_by_program">Filtrar por Programa</label>
          <select id="program-filter" class="filter-select">
            <option value="all" data-key="all_programs">Todos los programas</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="date-filter" data-key="filter_by_date">Filtrar por Fecha de Emisión</label>
          <select id="date-filter" class="filter-select">
            <option value="all" data-key="all_dates">Todas las fechas</option>
          </select>
        </div>
      </div>

      <div id="certificates-list"></div>
      <p id="no-results-message" data-key="no_results_message">No se encontraron certificados que coincidan con los filtros seleccionados.</p>
    </section>

    <script>
      // --- Variables Globales y Constantes ---
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxCN3pDynC7iNORHckEunyzCZ1MGC7pTSMF5VAC0lTJoHZtSGWjByL2q88cuzkkEy3kVw/exec";
      
      let allCertificates = [];
      let currentLang = 'es';

      // --- Diccionario de Traducciones ---
      const translations = {
        es: {
            validation_portal: "Portal de Validación",
            search_prompt: "Ingresa tu número de Carnet de Identidad (CI) para consultar y verificar tus certificados emitidos.",
            verify_button_title: "Verificar",
            new_search_button_title: "Realizar Nueva Búsqueda",
            filter_by_program: "Filtrar por Programa",
            all_programs: "Todos los programas",
            filter_by_date: "Filtrar por Fecha de Emisión",
            all_dates: "Todas las fechas",
            no_results_message: "No se encontraron certificados que coincidan con los filtros seleccionados.",
            error_invalid_ci_title: "Carnet no válido",
            error_invalid_ci_msg: "Por favor, ingrese un número de carnet válido (al menos 7 dígitos, sin letras ni guiones).",
            error_not_found_title: "Certificado no encontrado",
            error_not_found_msg: "Verifique que el número sea correcto. Si el problema persiste, por favor contacte al soporte.",
            error_connection_title: "Error de Conexión",
            error_connection_msg: "No se pudo conectar con el servidor. Por favor, verifique su conexión a internet e inténtelo de nuevo.",
            results_title_prefix: "Tus Certificados",
            results_count_text: (found, total) => `Se encontraron ${found} de ${total} certificados.`,
            card_issued_on: "Emitido el:",
            card_badge_student: "Estudiante",
            card_badge_teacher: "Docente",
            view_certificate_title: "Ver Certificado (PDF)"
        },
        en: {
            validation_portal: "Validation Portal",
            search_prompt: "Enter your ID number to check and verify your issued certificates.",
            verify_button_title: "Verify",
            new_search_button_title: "Perform New Search",
            filter_by_program: "Filter by Program",
            all_programs: "All programs",
            filter_by_date: "Filter by Issue Date",
            all_dates: "All dates",
            no_results_message: "No certificates were found matching the selected filters.",
            error_invalid_ci_title: "Invalid ID",
            error_invalid_ci_msg: "Please enter a valid ID number (at least 7 digits, without letters or dashes).",
            error_not_found_title: "Certificate not found",
            error_not_found_msg: "Please verify the number is correct. If the problem persists, please contact support.",
            error_connection_title: "Connection Error",
            error_connection_msg: "Could not connect to the server. Please check your internet connection and try again.",
            results_title_prefix: "Certificates for",
            results_count_text: (found, total) => `Found ${found} of ${total} certificates.`,
            card_issued_on: "Issued on:",
            card_badge_student: "Student",
            card_badge_teacher: "Teacher",
            view_certificate_title: "View Certificate (PDF)"
        }
      };

      // --- Selectores del DOM ---
      const searchView = document.getElementById("search-view");
      const resultsView = document.getElementById("results-view");
      const form = document.getElementById("search-form");
      const searchInput = document.getElementById("search-input");
      const submitButton = form.querySelector('button[type="submit"]');
      const loader = document.getElementById("loader");
      const errorContainer = document.getElementById("error-container");
      
      const certificatesListContainer = document.getElementById("certificates-list");
      const resultsTitle = document.getElementById("results-title");
      const resultsCount = document.getElementById("results-count");
      const programFilter = document.getElementById("program-filter");
      const dateFilter = document.getElementById("date-filter");
      const newSearchButton = document.getElementById("new-search");
      const noResultsMessage = document.getElementById("no-results-message");

      // --- Manejadores de Eventos ---
      form.addEventListener("submit", handleSearchSubmit);
      programFilter.addEventListener("change", applyFiltersAndRender);
      dateFilter.addEventListener("change", applyFiltersAndRender);
      newSearchButton.addEventListener("click", resetToSearchView);
      document.getElementById('lang-es').addEventListener('click', () => setLanguage('es'));
      document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));


      // --- Lógica de Idioma ---
      function setLanguage(lang) {
        currentLang = lang;
        document.documentElement.lang = lang;
        
        document.querySelectorAll('[data-key]').forEach(elem => {
            const key = elem.getAttribute('data-key');
            elem.textContent = translations[lang][key];
        });

        document.querySelectorAll('[data-key-title]').forEach(elem => {
            const key = elem.getAttribute('data-key-title');
            elem.title = translations[lang][key];
        });
        
        // Actualizar placeholder
        searchInput.placeholder = lang === 'es' ? "Ej: 12345678" : "E.g: 12345678";
        
        // Activar/desactivar botones de idioma
        document.getElementById('lang-es').classList.toggle('active', lang === 'es');
        document.getElementById('lang-en').classList.toggle('active', lang === 'en');
        
        // Re-renderizar si estamos en la vista de resultados para actualizar textos
        if (resultsView.style.display === 'flex') {
            applyFiltersAndRender();
        }
      }


      // --- Lógica Principal de Búsqueda ---
      async function handleSearchSubmit(e) {
        e.preventDefault();
        const searchId = searchInput.value.trim().replace(/\s/g, "");

        if (!/^\d{7,}$/.test(searchId)) {
          displayError(
            translations[currentLang].error_invalid_ci_title,
            translations[currentLang].error_invalid_ci_msg
          );
          return;
        }
        
        setLoadingState(true);

        try {
          const response = await fetch(`${SCRIPT_URL}?searchId=${encodeURIComponent(searchId)}`);
          const result = await response.json();

          if (result.success && result.data.length > 0) {
            allCertificates = result.data;
            switchToResultsView();
            populateFilters();
            applyFiltersAndRender();
          } else {
            displayError(
              translations[currentLang].error_not_found_title,
              translations[currentLang].error_not_found_msg,
              true // Show contact info for this specific error
            );
          }
        } catch (error) {
          console.error("Fetch error:", error);
          displayError(translations[currentLang].error_connection_title, translations[currentLang].error_connection_msg);
        } finally {
          setLoadingState(false);
        }
      }

      // --- Manipulación de Vistas y Estados ---
      function setLoadingState(isLoading) {
        if (isLoading) {
            submitButton.disabled = true;
            loader.style.display = "flex";
            errorContainer.innerHTML = "";
        } else {
            submitButton.disabled = false;
            loader.style.display = "none";
        }
      }
      
      function switchToResultsView() {
          searchView.style.display = "none";
          resultsView.style.display = "flex";
          resultsView.style.animation = "fadeIn 0.8s ease-in-out";
      }

      function resetToSearchView() {
          resultsView.style.display = "none";
          searchView.style.display = "flex";
          searchView.style.animation = "fadeIn 0.8s ease-in-out";
          searchInput.value = "";
          errorContainer.innerHTML = "";
          allCertificates = [];
          certificatesListContainer.innerHTML = "";
      }

      // --- Lógica de Filtros y Renderizado ---
      function populateFilters() {
        const uniquePrograms = [...new Set(allCertificates.map(cert => cert.descripcion))];
        const uniqueDates = [...new Set(allCertificates.map(cert => cert.fecha))];
        
        programFilter.innerHTML = `<option value="all">${translations[currentLang].all_programs}</option>`;
        dateFilter.innerHTML = `<option value="all">${translations[currentLang].all_dates}</option>`;

        uniquePrograms.forEach(program => {
            const option = document.createElement('option');
            option.value = program;
            option.textContent = program;
            programFilter.appendChild(option);
        });

        uniqueDates.sort().forEach(date => {
            const option = document.createElement('option');
            option.value = date;
            option.textContent = date;
            dateFilter.appendChild(option);
        });
      }

      function applyFiltersAndRender() {
        const selectedProgram = programFilter.value;
        const selectedDate = dateFilter.value;

        const filteredCertificates = allCertificates.filter(cert => {
            const programMatch = selectedProgram === 'all' || cert.descripcion === selectedProgram;
            const dateMatch = selectedDate === 'all' || cert.fecha === selectedDate;
            return programMatch && dateMatch;
        });

        renderCertificates(filteredCertificates);
      }
      
      function renderCertificates(certificatesToRender) {
        const holderName = allCertificates[0]?.nombre || 'User';
        resultsTitle.innerHTML = `<i class="fi fi-rr-file-certificate"></i> ${translations[currentLang].results_title_prefix} ${holderName}`;
        resultsCount.textContent = translations[currentLang].results_count_text(certificatesToRender.length, allCertificates.length);

        certificatesListContainer.innerHTML = "";

        if (certificatesToRender.length === 0) {
            noResultsMessage.style.display = "block";
            certificatesListContainer.style.display = "none";
        } else {
            noResultsMessage.style.display = "none";
            certificatesListContainer.style.display = "grid";
        }
        
        certificatesToRender.forEach((cert, index) => {
          const typeKey = cert.type.toLowerCase() === 'estudiante' ? 'student' : 'teacher';
          const typeClass = cert.type.toLowerCase();
          const card = document.createElement('div');
          card.className = `certificate-card`;
          card.style.animationDelay = `${index * 100}ms`;
          card.innerHTML = `
              <div class="card-header">
                <h3>${cert.descripcion}</h3>
                <span class="certificate-badge ${typeClass}">${translations[currentLang]['card_badge_' + typeKey]}</span>
              </div>
              <div class="card-body">
                <p><strong>${translations[currentLang].card_issued_on}</strong> ${cert.fecha}</p>
              </div>
              <div class="card-footer">
                <a href="${cert.urlPdf}" target="_blank" rel="noopener noreferrer" class="download-link ${typeClass}" title="${translations[currentLang].view_certificate_title}">
                  <i class="fi fi-rr-file-pdf"></i>
                </a>
              </div>`;
          certificatesListContainer.appendChild(card);
        });
      }

      // --- Manejo de Errores ---
      function displayError(title, message, showContact = false) {
        let contactInfo = "";
        if (showContact) {
            const WHATSAPP_NUMBER = "59174681419";
            const PREWRITTEN_MESSAGE = currentLang === 'es' ? "Hola, tengo una consulta sobre mi certificado. Soy: " : "Hello, I have a query about my certificate. I am: ";
            const WHATSAPP_URL = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(PREWRITTEN_MESSAGE)}`;
            contactInfo = `
                <div class="contact-support">
                    <a href="mailto:efrain.chiri@esam.edu.bo" title="Enviar correo">
                        <img src="https://cdn.icon-icons.com/icons2/2631/PNG/512/gmail_new_logo_icon_159149.png" alt="Email" width="30">
                    </a>
                    <a href="${WHATSAPP_URL}" target="_blank" title="Contactar por WhatsApp">
                        <img src="https://cdn.icon-icons.com/icons2/729/PNG/512/whatsapp_icon-icons.com_62756.png" alt="WhatsApp" width="30">
                    </a>
                </div>`;
        }

        errorContainer.innerHTML = `
          <div class="error-message">
            <strong>${title}:</strong> ${message}
            ${contactInfo}
          </div>`;
      }

      // Iniciar con el idioma por defecto
      document.addEventListener('DOMContentLoaded', () => setLanguage(currentLang));
    </script>
</body>
</html>
